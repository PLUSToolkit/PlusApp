<PlusConfiguration version="2.0">
	<DataCollection StartupDelaySec="1.0">
		<Device
			Id="Ascension3DG"
			Type="Ascension3DG"
			AcquisitionRate="50" 
			LocalTimeOffsetSec="0.0"	
			AveragedItemsForFiltering="20"
			FilterAcWideNotch="1"
		>
			<Tool Id="Probe" BufferSize="500" PortName="0"/>
			<Tool Id="Reference" BufferSize="500" PortName="1"/>
			<Tool Id="Stylus" BufferSize="500" PortName="2"/>
		
			<OutputStream Id="AscensionTrackerAllTools">
				<Tool Id="Probe"/>
				<Tool Id="Reference"/>
				<Tool Id="Stylus"/>
			</OutputStream>
		
			<OutputStream Id="AscensionTrackerProbeOnly">
				<Tool Id="Probe"/>
			</OutputStream>
		</Device>
	
		<!-- if smart device: will poll hardware to see if parameters have changed, if so, will output on the stream that
				matches the new parameters -->
		<Device 
			Id="SonixVideo"
			Type="SonixVideo"
			BufferSize="500" 
			UsImageOrientation="UF"
			AcquisitionRate="30" 
			AveragedItemsForFiltering="20" 
			LocalTimeOffsetSec="-0.2976"
			IP="130.15.7.20" 
			ImagingMode="BMode"
			AcquisitionDataType="BPost" 
			Depth="-1" 
			Sector="-1" 
			Gain="-1" 
			DynRange="-1" 
			Zoom="-1" 
			Frequency="-1" 
			Timeout="-1" 
			CompressionStatus="0" 
		>
			<RfProcessing>
				<RfToBrightnessConversion NumberOfHilberFilterCoeffs="32.0" BrightnessScale="20.0"/>
				<ScanConversion TransducerName="Ultrasonix_L9-4/38"
					TransducerGeometry="LINEAR"
					ImagingDepthMm="55.0"
					TransducerWidthMm="38.0"
					OutputImageSizePixel="220 300"
					OutputImageSpacingMmPerPixel="0.2 0.2"		
				/>
			</RfProcessing> 
			<OutputStream Id="SonixVideoAxialPlaneRFMode" />
			<OutputStream Id="SonixVideoAxialPlaneBMode" />
			<OutputStream Id="SonixVideoSagittalPlaneRFMode" />
			<OutputStream Id="SonixVideoSagittalPlaneBMode" />
		</Device>

		<Device Id="AxialMixer" Type="VirtualStreamMixer">
			<OutputStream Id="TrackedFrameOutputAxial" />
			<InputStream Id="SonixVideoAxialPlaneBMode" />
			<InputStream Id="AscensionTrackerAllTools" />
		</Device>
		<Device Id="SagittalMixer" Type="VirtualStreamMixer">
			<OutputStream Id="TrackedFrameOutputSagittal" />
			<InputStream Id="SonixVideoSagittalPlaneBMode" />
			<InputStream Id="AscensionTrackerAllTools" />
		</Device>

		<!-- Is this the device to add context awareness? -->
		<Device Id="SaveDataTargetSwitcher" Type="VirtualStreamSwitcher">
			<OutputStream Id="SaveDataOutputAll"
				<!-- this device will need to broadcast stream switches -->
				Image from TrackedFrameOutputAxial / TrackedFrameOutputSagittal
				Transforms:
				ImageToReference: from ImageToReference_Axial / ImageToReference_Sagittal
				NeedleToReference: from NeedleToReference_Axial / NeedleToReference_Sagittal
			/>
			<!-- device also needs to be able to be polled for current postfix, as data collector will need to know which set of transforms to access... -->
			<!-- this means that this device has to be known by the data collector... all devices of type switcher? -->
			<!--     no worse than knowing about the tracked frame producers... -->
			<Context InputStream="TrackedFrameOutputAxial" Postfix="Axial" /> <!-- also performs the same actions as <InputStream ... > -->
			<Context InputStream="TrackedFrameOutputSagittal" Postfix="Sagittal" /> <!-- also performs the same actions as <InputStream ... > -->
		</Device>
	</DataCollection>

	<CoordinateDefinitions>
		<Transform From="Image" To="TransducerOriginPixel"
			Matrix="
			1	0	0	-410
			0	1	0	5
			0	0	1	0
			0	0	0	1"
			Date="2011.12.06 17:57:00"/>
		<Transform From="Phantom" To="Reference"
			Matrix="
			-0.0167397	-0.0153548	-0.999742	15.6642
			-0.999834	0.0075107	0.0166258	-25.3628
			0.00725347	0.999854	-0.015478	-40.7799
				0	0	0	1"
			Error="0.660751" Date="091112_152716"/>
		<Transform From="StylusTip" To="Stylus"
			Matrix="
			0.997221	0.0675365	0.0314631	194.844
			-0.06757	0.997715	0	-13.2023
			-0.0313912	-0.00212596	0.999505	-6.13342
			0	0	0	1"
			Error="0.450335" Date="091112_150057"/>
		<Transform From="TransducerOriginPixel" To="TransducerOrigin"
			Matrix="
			0.0796446	0	0	0
			0	0.0744856	0	0
			0	0	0.0770651	0
			0	0	0	1"
			Date="091112_160011"/>
	</CoordinateDefinitions>

	<Rendering WorldCoordinateFrame="Reference" DisplayedImageOrientation="MARKED_RIGHT_FAR_DOWN">
		<DisplayableObject Type="Model" ObjectCoordinateFrame="TransducerOrigin" Id="ProbeModel"
			File="L14-5_38_ProbeModel.stl"
			ModelToObjectTransform="
			-1 0 0 29.7
			0 -1 0 1.5
			0 0 1 -14
			0 0 0 1"
		/>
		<DisplayableObject Type="Model" ObjectCoordinateFrame="Reference" Id="Volume"/>
		<DisplayableObject Type="Model" ObjectCoordinateFrame="StylusTip" Id="StylusModel"
			File="Stylus_Example.stl"
			ModelToObjectTransform="
			1 0 0 -210.0
			0 1 0 0
			0 0 1 0
			0 0 0 1"
		/>
		<DisplayableObject Id="PhantomModel" Type="Model" ObjectCoordinateFrame="Phantom"
			Opacity="0.6"
			File="FCal_2.0.stl"
			ModelToObjectTransform="
			1 0 0 -35.0
			0 1 0 -10.0
			0 0 1 -5.0
			0 0 0 1"
		/>
		<DisplayableObject Type="Image" ObjectCoordinateFrame="Image" Id="LiveImage"/>
	</Rendering>


	<Segmentation
		ApproximateSpacingMmPerPixel="0.078"
		MorphologicalOpeningCircleRadiusMm="0.27"
		MorphologicalOpeningBarSizeMm="1.0"
		RegionOfInterest="27 27 793 589"
		MaxLinePairDistanceErrorPercent="10"
		AngleToleranceDegrees="10"
		MaxAngleDifferenceDegrees="10"
		MinThetaDegrees="-70"
		MaxThetaDegrees="70"
		MaxLineShiftMm="10.0"
		MaxCandidates="20"
		ThresholdImagePercent="10"
		CollinearPointsMaxDistanceFromLineMm="0.6"
		UseOriginalImageIntensityForDotIntensityScore="0"
	/>
	

	<PhantomDefinition>
		<!-- Supported types are: Double-N, U-Shaped-N -->
		<Description
			Name="fCAL"
			Type="Double-N"
			Version="2.0"
			WiringVersion="2.0"
			Institution="Queen's University PerkLab"
		/>

		<Geometry>		
			<Pattern Type="NWire">
				<Wire Name="7:G1_g1" EndPointFront="30.0 0.0 20.0" EndPointBack="30.0 40.0 20.0" />
				<Wire Name="8:L1_h1" EndPointFront="55.0 0.0 20.0" EndPointBack="35.0 40.0 20.0" />
				<Wire Name="9:M1_m1" EndPointFront="60.0 0.0 20.0" EndPointBack="60.0 40.0 20.0" />
			</Pattern>
			<Pattern Type="NWire">
				<Wire Name="4:G3_g3" EndPointFront="30.0 0.0 10.0" EndPointBack="30.0 40.0 10.0" />
				<Wire Name="5:H3_l3" EndPointFront="35.0 0.0 10.0" EndPointBack="55.0 40.0 10.0" />
				<Wire Name="6:M3_m3" EndPointFront="60.0 0.0 10.0" EndPointBack="60.0 40.0 10.0" />
			</Pattern>
			<Pattern Type="NWire">
				<Wire Name="1:H5_h5" EndPointFront="35.0 0.0 0.0" EndPointBack="35.0 40.0 0.0" />
				<Wire Name="2:L5_i5" EndPointFront="55.0 0.0 0.0" EndPointBack="40.0 40.0 0.0" />
				<Wire Name="3:M5_m5" EndPointFront="60.0 0.0 0.0" EndPointBack="60.0 40.0 0.0" />
			</Pattern>

			<Landmarks>
				<Landmark Name="#1" Position="104.3 5.0 20.0" />
				<Landmark Name="#2" Position="104.3 45.0 20.0" />
				<Landmark Name="#3" Position="104.3 45.0 0.0" />
				<Landmark Name="#4" Position="104.3 -5.0 0.0" />

				<Landmark Name="#5" Position="-34.3 45.0 15.0" />
				<Landmark Name="#6" Position="-34.3 -5.0 20.0" />
				<Landmark Name="#7" Position="-34.3 -5.0 0.0" />
				<Landmark Name="#8" Position="-34.3 45.0 0.0" />
			</Landmarks>
		</Geometry>
	</PhantomDefinition>

	<VolumeReconstruction 
		OutputSpacing="0.5 0.5 0.5"
		ClipRectangleOrigin="0 0"
		ClipRectangleSize="820 616"
		Interpolation="LINEAR"
		Optimization="FULL"
		Compounding="On"
		FillHoles="Off"
	/>

	<fCal
		PhantomModelId="PhantomModel"
		ReconstructedVolumeId="Volume"
		TransducerModelId="ProbeModel"
		StylusModelId="StylusModel"
		ImageDisplayableObjectId="LiveImage"
		NumberOfCalibrationImagesToAcquire="140"
		NumberOfValidationImagesToAcquire="70"
		NumberOfStylusCalibrationPointsToAcquire="200"
		RecordingIntervalMs="100"
		MaxTimeSpentWithProcessingMs="70"
		ImageCoordinateFrame="Image"
		ProbeCoordinateFrame="Probe"
		ReferenceCoordinateFrame="Reference"
		TransducerOriginCoordinateFrame="TransducerOrigin"
		TransducerOriginPixelCoordinateFrame="TransducerOriginPixel"
		TemporalCalibrationDurationSec="10"
	/>

	<vtkPivotCalibrationAlgo
		ObjectMarkerCoordinateFrame="Stylus"
		ReferenceCoordinateFrame="Reference"
		ObjectPivotPointCoordinateFrame="StylusTip"
	/>

	<vtkPhantomRegistrationAlgo
		PhantomCoordinateFrame="Phantom"
		ReferenceCoordinateFrame="Reference"
		StylusTipCoordinateFrame="StylusTip"
	/>

	<vtkProbeCalibrationAlgo
		ImageCoordinateFrame="Image"
		ProbeCoordinateFrame="Probe"
		PhantomCoordinateFrame="Phantom"
		ReferenceCoordinateFrame="Reference"
	/>

</PlusConfiguration>
